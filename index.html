<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stroop Task Experiment</title>
    <script src="https://unpkg.com/jspsych@8.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text@2.0.0"></script>
    <link href="https://unpkg.com/jspsych@8.0.0/css/jspsych.css" rel="stylesheet" type="text/css" />
    <style>
        body {
            background-color: black;
            color: white;
            font-family: Arial, sans-serif;
        }
        .response-button {
            padding: 10px 20px;
            margin: 10px;
            font-size: 16px;
            cursor: pointer;
            background-color: white;
            color: black;
            border: none;
            border-radius: 5px;
        }
        .nudge-circle {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            margin: 0 auto;
        }
        .result-table {
            color: white;
            border-collapse: collapse;
            width: 100%;
        }
    </style>
</head>
<body>
    <div id="jspsych-target"></div>
    <div id="trial-table"></div> <!-- Added table div -->

    <script>
        // Initialize JsPsych
        const jsPsych = initJsPsych({
            override_safe_mode: true,
            on_finish: function() {
                // Removed displaying all data
            }
        });

        function showUploadStatus() {
            var jspsych_content = document.getElementById("jspsych-content");
            jspsych_content.innerHTML = 'Uploading your data<br><br><div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div>'
        }

        function onUploadSuccess() {
            var jspsych_content = document.getElementById("jspsych-content");
            jspsych_content.innerHTML = 'Your data is successfully uploaded!';
        }

        function ajaxCall(url, data_row, subID, last_i, inbetween) {
            if (data_row.length - 2 <= last_i) {
                if (inbetween == 0) {
                    onUploadSuccess();
                }
            } else if ((subID == -1) && (last_i != 0)) {
                jQuery.ajax({
                    url: url,
                    method: "GET",
                    data: [{ name: "getSubID", value: 1 }],
                }).done(
                    function(__e) {
                        ajaxCall(url, data_row, __e['subID'], last_i, inbetween);
                    }
                ).fail(function(__e) {
                    return 0;
                });
            } else {
                var data = [];
                var flag = true;
                data.push(data_row[0]);
                while (flag) {
                    if ((last_i < data_row.length - 2) && (data.join("\n").length + data_row[last_i + 1].length < 3500)) {
                        data.push(data_row[last_i + 1]);
                        last_i = last_i + 1;
                    } else {
                        jQuery.ajax({
                            url: url,
                            method: "GET",
                            data: [{ name: "data", value: data.join("\n") }, { name: "subID", value: subID }],
                        }).done(
                            function(__e) {
                                ajaxCall(url, data_row, __e['subID'], last_i, inbetween);
                            }
                        ).fail(function(__e) {
                            return 0;
                        });

                        flag = false;
                    }
                }
            }
        }

        var jsPsychSheet = {
            lastrow: 0,

            uploadPartialData: function(url, data, inbetween = 1) {
                var data_row = data.split(/\r?\n|\r/);
                ajaxCall(url, data_row, -1, this.lastrow, inbetween);
                this.lastrow = data_row.length - 2;
            },

            uploadData: function(url, data, inbetween = 0) {
                if (inbetween == 0) {
                    showUploadStatus();
                }

                var data_row = data.split(/\r?\n|\r/);
                ajaxCall(url, data_row, -1, this.lastrow, inbetween);
                this.lastrow = data_row.length - 2;
            }
        }

        const colours = ['red', 'green', 'blue', 'yellow'];
        const n_trials = 20; // Total number of trials in the main experiment
        const trials = []; // Array to hold the trial data
        let mainExperimentCorrectResponses = 0; // Counter for correct responses in the main experiment
        let testCorrectResponses = 0; // Counter for correct responses in the test phase
        const trialDataArray = []; // To hold data for the results table

        // Instructions for the experiment
        const instructions = {
            type: jsPsychHtmlButtonResponse,
            stimulus: "<p>Welcome to the Stroop task experiment!</p>" +
                      "<p>In this task, you will see words displayed in different colors.</p>" +
                      "<p>Your goal is to identify the color of the word, not the word itself.</p>" +
                      "<p>Please respond as quickly and accurately as possible.</p>" +
                      "<p>Click 'Next' to start the experiment.</p>",
            choices: ['Next']
        };

        // Hardcoded test trials
        const testTrials = [
            {
                stimulus: '<p style="font-size:60px; color: green;">blue</p>', // Incongruent trial (blue word in green font)
                choices: ['green', 'blue'],
                correct_response: 'green' // The correct button for this trial is 'green'
            },
            {
                stimulus: '<p style="font-size:60px; color: red;">red</p>', // Congruent trial (red word in red font)
                choices: ['green', 'red'],
                correct_response: 'red' // The correct button for this trial is 'red'
            },
            {
                stimulus: '<p style="font-size:60px; color: blue;">yellow</p>', // Incongruent trial (yellow word in blue font)
                choices: ['yellow', 'blue'],
                correct_response: 'blue' // The correct button for this trial is 'blue'
            }
        ];

        // Test phase instructions
        const testInstructions = {
            type: jsPsychHtmlButtonResponse,
            stimulus: "<p>Now we will begin a short test phase.</p>" +
                      "<p>You will see some words displayed in different colors.</p>" +
                      "<p>Please respond as quickly and accurately as possible.</p>" +
                      "<p>Click 'Next' to start the test phase.</p>",
            choices: ['Next']
        };

        // Push test instructions to the timeline
        const timeline = [instructions, testInstructions];

        // Initialize correct response tracking for the test phase
        testTrials.forEach((trial) => {
            const testTrial = {
                type: jsPsychHtmlButtonResponse,
                stimulus: trial.stimulus,
                choices: trial.choices,
                data: {
                    correct_response: trial.correct_response
                },
                on_finish: function(data) {
                    // Check if response is correct
                    const responseIndex = data.response;
                    const isCorrect = responseIndex !== null && trial.choices[responseIndex] === trial.correct_response;
                    data.correct = isCorrect; // Store whether the response was correct

                    if (isCorrect) {
                        testCorrectResponses++; // Increment correct responses count
                    }
                }
            };
            timeline.push(testTrial);
        });

        // Feedback after the test trials
        const feedbackTestPhase = {
            type: jsPsychHtmlButtonResponse,
            stimulus: function() {
                return `<p>You got ${testCorrectResponses} out of ${testTrials.length} correct in the test phase.</p>`;
            },
            choices: ['Continue to Main Experiment']
        };
        timeline.push(feedbackTestPhase); // Push feedback to the timeline

        // Function to get a random incorrect color
        function getRandomIncorrectColor(correctColor) {
            const incorrectColors = colours.filter(color => color !== correctColor);
            return incorrectColors[Math.floor(Math.random() * incorrectColors.length)];
        }

        // Generate congruent and incongruent trials
        const n_congruent = n_trials / 2; // Number of congruent trials
        const n_incongruent = n_trials / 2; // Number of incongruent trials

        // Generate congruent trials
        for (let i = 0; i < n_congruent; i++) {
            const word = colours[Math.floor(Math.random() * colours.length)];
            const correctColor = word; // Correct color is the same as the word

            const correctChoice = correctColor;
            const incorrectChoice = getRandomIncorrectColor(correctChoice);
            const choices = jsPsych.randomization.shuffle([correctChoice, incorrectChoice]); // Randomize button order

            // Create trial object for congruent trial
            const trial = {
                type: jsPsychHtmlButtonResponse,
                stimulus: `<p style='font-size:60px; color: ${correctColor};'>${word}</p>`,
                choices: choices,
                data: {
                    correct_response: correctChoice,
                    trial_type: "congruent",
                    displayed_color: correctColor // Store the displayed color for nudge trials
                },
                on_finish: function(data) {
                    const responseIndex = data.response;
                    const isCorrect = responseIndex !== null && choices[responseIndex] === correctChoice;
                    data.correct = isCorrect;

                    if (isCorrect) {
                        mainExperimentCorrectResponses++; // Increment correct responses count
                    }
                }
            };

            trials.push(trial); // Add to trials array
        }

        // Generate incongruent trials
        for (let i = 0; i < n_incongruent; i++) {
            const word = colours[Math.floor(Math.random() * colours.length)];
            const correctColor = getRandomIncorrectColor(word); // Correct color is not the same as the word

            const correctChoice = correctColor;
            const incorrectChoice = word; // Incorrect choice is the word
            const choices = jsPsych.randomization.shuffle([correctChoice, incorrectChoice]); // Randomize button order

            // Create trial object for incongruent trial
            const trial = {
                type: jsPsychHtmlButtonResponse,
                stimulus: `<p style='font-size:60px; color: ${correctColor};'>${word}</p>`,
                choices: choices,
                data: {
                    correct_response: correctChoice,
                    trial_type: "incongruent",
                    displayed_color: correctColor // Store the displayed color for nudge trials
                },
                on_finish: function(data) {
                    const responseIndex = data.response;
                    const isCorrect = responseIndex !== null && choices[responseIndex] === correctChoice;
                    data.correct = isCorrect;

                    if (isCorrect) {
                        mainExperimentCorrectResponses++; // Increment correct responses count
                    }
                }
            };

            trials.push(trial); // Add to trials array
        }

        // Create an array of indices to randomly choose nudge trials
        const nudgeTrialIndices = jsPsych.randomization.sampleWithoutReplacement(Array.from({ length: n_trials }, (_, i) => i), Math.floor(n_trials / 3));

        // Add trials and nudge trials to the timeline
        let lastWasNudge = false; // Track if the last trial was a nudge trial
        for (let i = 0; i < trials.length; i++) {
            // Only push a nudge trial if the last trial was not a nudge
            if (nudgeTrialIndices.includes(i) && !lastWasNudge) {
                if (i + 1 < trials.length) { // Check if there is a next trial
                    const nextTrial = trials[i + 1]; // Get the next trial
                    const nudgeColor = nextTrial.data.displayed_color; // Use the color of the following trial's font color

                    // Nudge trial
                    timeline.push({
                        type: jsPsychHtmlButtonResponse,
                        stimulus: `<div class='nudge-circle' style='background-color: ${nudgeColor};'></div>`,
                        choices: [],  // No choices during the nudge display
                        trial_duration: 300,  // Show nudge for 300 ms
                        data: { isNudge: true }
                    });

                    lastWasNudge = true; // Set flag indicating the last trial was a nudge
                }
            } else {
                lastWasNudge = false; // Reset the flag if it wasn't a nudge
            }

            timeline.push(trials[i]); // Add the main trial
        }

        // Randomize the order of the trials
        jsPsych.randomization.shuffle(trials);
        // Demographic questions (moved to the end)
        const demographicQuestions = [
            {
                type: jsPsychSurveyText,
                questions: [{ prompt: "In which country were you born?", required: true }]
            },
            {
                type: jsPsychHtmlButtonResponse,
                stimulus: "<p>Do you identify as:</p>",
                choices: ['Male', 'Female', 'Do not wish to specify/Other'],
                data: { question: "gender_identity" }
            },
            {
                type: jsPsychHtmlButtonResponse,
                stimulus: "<p>Are you colorblind?</p>",
                choices: ['Yes', 'No'],
                data: { question: "colorblind" }
            },
            // Age question moved to the end
            {
                type: jsPsychSurveyText,
                questions: [{ prompt: "How old are you?", required: true }],
                on_finish: function(data) {
                    data.timestamp = Date.now(); // Capture the timestamp
                    data.age = data.response; // Capture the age
                    jsPsych.data.addDataToLastTrial({ age: data.age }); // Explicitly add age to the last trial
                    // Update trial data array with age for each trial
                    trialDataArray.forEach(trial => {
                        trial.age = data.age; // Assign the age to each trial data
                    });
                }
            }
        ];

        // Add demographic questions to the timeline
        timeline.push(...demographicQuestions);
        // Results phase
        const resultsPhase = {
            type: jsPsychHtmlButtonResponse,
            stimulus: function() {
                return `<p>You got ${mainExperimentCorrectResponses} out of ${n_trials} correct in the main experiment.</p>`;
            },
            choices: ['Finish'],
            on_finish: function(data) {
                // Define the function to send data to Google Sheets
function sendDataToGoogleSheets(data) {
    const subjectID = data.subID || null; // Assign subject ID if provided
    const csvData = data.csv || null; // Get CSV data to send

    if (!csvData) {
        console.error('No data to send to Google Sheets.');
        return;
    }

    const url = 'https://script.google.com/macros/s/AKfycbxauFri0MuKDhuOrbqwOl1ddaKItpZb7JNjwAv6nCy4u1sBEWiEHvxtFBVFJIjbTY7C/exec'; // Replace with your actual Apps Script URL
    const params = {
        method: 'POST',
        contentType: 'application/x-www-form-urlencoded',
        payload: {
            subID: subjectID,
            data: csvData
        }
    };

   
        
        // Send the collected data to Google Sheets
        sendDataToGoogleSheets(data);
        
        // You might want to display the results or redirect the user
        // jsPsych.data.displayData();
    }
});
                const participantData = jsPsych.data.get().json(); // Get participant data
                jsPsychSheet.uploadData('https://script.google.com/macros/s/AKfycbxauFri0MuKDhuOrbqwOl1ddaKItpZb7JNjwAv6nCy4u1sBEWiEHvxtFBVFJIjbTY7C/exec', participantData); // Upload data
            }
        };
        timeline.push(resultsPhase); // Add results phase to the timeline

        // Start the experiment
        jsPsych.run(timeline);
    </script>
</body>
</html>



