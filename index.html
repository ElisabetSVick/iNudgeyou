<!DOCTYPE html>
<html lang="da">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stroop Opgave Eksperiment</title>

    <!-- Load jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- jsPsych core library -->
    <script src="https://unpkg.com/jspsych@8.0.0"></script>

    <!-- Plugins for jsPsych -->
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text@2.0.0"></script>

    <!-- CSS for jsPsych -->
    <link href="https://unpkg.com/jspsych@8.0.0/css/jspsych.css" rel="stylesheet" type="text/css" />

    <style>
        body {
            background-color: black;
            color: white;
        }

        .response-button {
            padding: 10px 20px;
            margin: 10px;
            font-size: 16px;
            cursor: pointer;
        }

        .nudge-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 20px auto;
        }
    </style>
</head>

<body>
    <div id="jspsych-target"></div>

    <script>
        // jsPsychSheet v2 - A simple JavaScript library to use jsPsych and Google Sheet to run behavioral experiments online.
        // Created by Shashi Kant Gupta, June 06, 2021.

        function showUploadStatus() {
            var jspsych_content = document.getElementById("jspsych-content");
            jspsych_content.innerHTML = 'Uploading your data<br><br><div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div>';
        }

        function onUploadSuccess() {
            var jspsych_content = document.getElementById("jspsych-content");
            jspsych_content.innerHTML = 'Your data is successfully uploaded!';
        }

        function ajaxCall(url, data_row, subID, last_i, inbetween) {
            if (data_row.length - 2 <= last_i) {
                console.log('Remote sheet updated!', data_row.length, last_i, inbetween);
                if (inbetween == 0) {
                    onUploadSuccess();
                }
            } else if ((subID == -1) && (last_i != 0)) {
                jQuery.ajax({
                    url: url,
                    method: "GET",
                    data: [{ name: "getSubID", value: 1 }],
                }).done(function(__e) {
                    ajaxCall(url, data_row, __e['subID'], last_i, inbetween);
                }).fail(function(__e) {
                    console.log('Remote sheet update failed', __e);
                    return 0;
                });
            } else {
                var data = [];
                var flag = true;
                data.push(data_row[0]);
                while (flag) {
                    if ((last_i < data_row.length - 2) && (data.join("\n").length + data_row[last_i + 1].length < 3500)) {
                        data.push(data_row[last_i + 1]);
                        last_i = last_i + 1;
                    } else {
                        jQuery.ajax({
                            url: url,
                            method: "GET",
                            data: [{ name: "data", value: data.join("\n") }, { name: "subID", value: subID }],
                        }).done(function(__e) {
                            console.log(Math.floor((last_i / (data_row.length - 2)) * 100).toString() + '% data sent!', __e);
                            ajaxCall(url, data_row, __e['subID'], last_i, inbetween);
                        }).fail(function(__e) {
                            console.log('Remote sheet update failed', __e);
                            return 0;
                        });

                        flag = false;
                    }
                }
            }
        }

        var jsPsychSheet = {
            lastrow: 0,

            uploadPartialData: function(url, data, inbetween = 1) {
                var data_row = data.split(/\r?\n|\r/);
                ajaxCall(url, data_row, -1, this.lastrow, inbetween);
                this.lastrow = data_row.length - 2;
            },

            uploadData: function(url, data, inbetween = 0) {
                if (inbetween == 0) {
                    showUploadStatus();
                }

                var data_row = data.split(/\r?\n|\r/);
                ajaxCall(url, data_row, -1, this.lastrow, inbetween);
                this.lastrow = data_row.length - 2;
            }
        };

        // Initialize JsPsych
        const jsPsych = initJsPsych({ override_safe_mode: true });

        // Mutation Observer to change "Continue" to "Forsæt"
        const observer = new MutationObserver((mutationsList) => {
            for (const mutation of mutationsList) {
                if (mutation.type === 'childList') {
                    mutation.addedNodes.forEach(node => {
                        if (node.nodeType === Node.ELEMENT_NODE) {
                            const buttons = node.querySelectorAll('button');
                            buttons.forEach(button => {
                                if (button.textContent.trim() === 'Continue') {
                                    button.textContent = 'Forsæt';
                                }
                            });
                        }
                    });
                }
            }
        });

        const targetNode = document.getElementById('jspsych-target');
        observer.observe(targetNode, { childList: true, subtree: true });

        // Unique ID for each participant
        const timestamp = new Date().toISOString();
        const uniqueID = timestamp.replace(/[:.-]/g, "");

        // Age question
        const ageQuestion = {
            type: jsPsychSurveyText,
            questions: [{ prompt: "Hvad er din alder?", required: true }],
            on_finish: function(data) {
                data.uniqueID = uniqueID;
                data.timestamp = timestamp;
                data.age = data.response; // Capture the age
                jsPsych.data.addDataToLastTrial({ age: data.age }); // Explicitly add age to the last trial
            }
        };

        // Stroop task definitions
        const stroop_trials = [
            { word: "rød", correct_color: "red" },
            { word: "grøn", correct_color: "green" },
            { word: "blå", correct_color: "blue" },
            { word: "gul", correct_color: "yellow" }
        ];

        // Get a random incorrect color, ensuring it's different from the correct one
        function getRandomIncorrectColor(correctColor) {
            const colors = ["red", "green", "blue", "yellow"];
            const incorrectColors = colors.filter(color => color !== correctColor);
            return incorrectColors[Math.floor(Math.random() * incorrectColors.length)];
        }

        const timeline = [ageQuestion];

        // Create an array of indices to randomly choose nudge trials
        const trialIndices = Array.from({ length: 20 }, (_, i) => i);
        const nudgeTrialIndices = jsPsych.randomization.sampleWithoutReplacement(trialIndices, Math.floor(20 / 3));  // Select 1/3 of trials as nudge trials (6-7 trials)

        // Create Stroop trials
        for (let i = 0; i < 20; i++) {
            const trial = stroop_trials[Math.floor(Math.random() * stroop_trials.length)];

            const isCongruentTrial = Math.random() < 0.5;
            let displayedColor;
            let correctButtonText = trial.word;
            let incorrectButtonText;

            // Determine displayed color and button text
            if (isCongruentTrial) {
                displayedColor = trial.correct_color;
                incorrectButtonText = getRandomIncorrectColor(trial.correct_color);
            } else {
                displayedColor = getRandomIncorrectColor(trial.correct_color);
                do {
                    incorrectButtonText = getRandomIncorrectColor(trial.correct_color);
                } while (incorrectButtonText === correctButtonText);
            }

            const correctButtonLeft = Math.random() < 0.5;  // Randomize button position
            const correctIndex = correctButtonLeft ? 0 : 1;  // Store the index of the correct button

            const choices = correctButtonLeft
                ? [correctButtonText, incorrectButtonText]
                : [incorrectButtonText, correctButtonText];

            // Map button text to Danish
            const buttonChoices = choices.map(color => {
                switch (color) {
                    case "red": return "rød";
                    case "green": return "grøn";
                    case "blue": return "blå";
                    case "yellow": return "gul";
                    default: return color;
                }
            });

            // If this trial is a nudge trial, first show the circle with the correct color
            if (nudgeTrialIndices.includes(i)) {
                // Nudge trial
                timeline.push({
                    type: jsPsychHtmlButtonResponse,
                    stimulus: `<div class='nudge-circle' style='background-color: ${trial.correct_color};'></div>`,
                    choices: [],  // No choices during the nudge display
                    trial_duration: 300,  // Show the circle for .3 seconds
                    on_finish: function() {
                        // Add the main trial after the nudge
                        timeline.push({
                            type: jsPsychHtmlButtonResponse,
                            stimulus: `<div style='font-size: 48px; color: ${displayedColor};'>${trial.word}</div>`,
                            choices: buttonChoices,
                            data: { correct: correctIndex },
                            on_finish: function(data) {
                                data.correct = data.response == data.correct;
                                data.uniqueID = uniqueID;
                                data.congruent = isCongruentTrial ? 1 : 0;
                            }
                        });
                    }
                });
            } else {
                // Non-nudge trial
                timeline.push({
                    type: jsPsychHtmlButtonResponse,
                    stimulus: `<div style='font-size: 48px; color: ${displayedColor};'>${trial.word}</div>`,
                    choices: buttonChoices,
                    data: { correct: correctIndex },
                    on_finish: function(data) {
                        data.correct = data.response == data.correct;
                        data.uniqueID = uniqueID;
                        data.congruent = isCongruentTrial ? 1 : 0;
                    }
                });
            }
        }

        // End of experiment
        timeline.push({
            type: jsPsychHtmlButtonResponse,
            stimulus: 'Tak fordi du deltog i eksperimentet!',
            choices: ['Afslut'],
            on_finish: function() {
                const data = jsPsych.data.get().csv();


                const sheetURL = "https://script.google.com/macros/s/AKfycbxauFri0MuKDhuOrbqwOl1ddaKItpZb7JNjwAv6nCy4u1sBEWiEHvxtFBVFJIjbTY7C/exec";
                jsPsychSheet.uploadData(sheetURL, data, 0);
            }
        });

        // Run experiment
        jsPsych.run(timeline);
    </script>
</body>

</html>
