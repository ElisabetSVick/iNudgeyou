<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stroop Opgave Eksperiment</title>
    <script src="https://unpkg.com/jspsych@8.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text@2.0.0"></script>
    <link href="https://unpkg.com/jspsych@8.0.0/css/jspsych.css" rel="stylesheet" type="text/css" />
    <style>
        body {
            background-color: black;
            color: white;
        }
        .response-button {
            padding: 10px 20px;
            margin: 10px;
            font-size: 16px;
            cursor: pointer;
        }
        .nudge-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 20px auto;
        }
    </style>
</head>
<body>
    <div id="jspsych-target"></div>

    <script>
        // Initialize JsPsych
        const jsPsych = initJsPsych({ override_safe_mode: true });

        // Unique ID for each participant
        const timestamp = new Date().toISOString().split('T')[0];  // Get date only (YYYY-MM-DD)
        const uniqueID = timestamp.replace(/[:.-]/g, "");

        // Age question
        const ageQuestion = {
            type: jsPsychSurveyText,
            questions: [{ prompt: "Hvad er din alder?", required: true }],
            on_finish: function(data) {
                data.uniqueID = uniqueID;
                data.timestamp = timestamp;
                data.age = data.response; // Capture the age
                jsPsych.data.addDataToLastTrial({ age: data.age }); // Add age to last trial
            }
        };

        // Stroop task definitions
        const stroop_trials = [
            { word: "rød", correct_color: "red" },
            { word: "grøn", correct_color: "green" },
            { word: "blå", correct_color: "blue" },
            { word: "gul", correct_color: "yellow" }
        ];

        // Get a random incorrect color, ensuring it's different from the correct one
        function getRandomIncorrectColor(correctColor) {
            const colors = ["red", "green", "blue", "yellow"];
            const incorrectColors = colors.filter(color => color !== correctColor);
            return incorrectColors[Math.floor(Math.random() * incorrectColors.length)];
        }

        const timeline = [ageQuestion];
        const nudgeTrialIndices = [];  // Track nudge trial indices
        const totalTrials = 20; // Total trials excluding nudge trials

        // Create Stroop trials
        for (let i = 0; i < totalTrials; i++) {
            const trial = stroop_trials[Math.floor(Math.random() * stroop_trials.length)];

            const isCongruentTrial = Math.random() < 0.5;
            let displayedColor;
            let correctButtonText = trial.word;
            let incorrectButtonText;

            // Determine displayed color and button text
            if (isCongruentTrial) {
                displayedColor = trial.correct_color;
                incorrectButtonText = getRandomIncorrectColor(trial.correct_color);
            } else {
                displayedColor = getRandomIncorrectColor(trial.correct_color);
                do {
                    incorrectButtonText = getRandomIncorrectColor(trial.correct_color);
                } while (incorrectButtonText === correctButtonText);
            }

            const correctButtonLeft = Math.random() < 0.5;  // Randomize button position
            const correctIndex = correctButtonLeft ? 0 : 1;  // Store the index of the correct button

            const choices = correctButtonLeft
                ? [correctButtonText, incorrectButtonText]
                : [incorrectButtonText, correctButtonText];

            // If this trial is a nudge trial, first show the circle with the correct color
            if (Math.random() < 0.3) {  // Randomly decide to make this a nudge trial (30% chance)
                // Nudge trial
                nudgeTrialIndices.push(i); // Track nudge trial index
                timeline.push({
                    type: jsPsychHtmlButtonResponse,
                    stimulus: `<div class='nudge-circle' style='background-color: ${trial.correct_color};'></div>`,
                    choices: [],  // No choices during the nudge display
                    trial_duration: 400,  // Show nudge for 400 ms
                    data: { isNudge: true }
                });
            }

            // Add the main Stroop task trial
            const stroop_task = {
                type: jsPsychHtmlButtonResponse,
                stimulus: `<p style='color: ${displayedColor}; font-size: 24px;'>${trial.word}</p>`,
                choices: choices,
                data: {
                    correct_response_index: correctIndex,  // Store the correct response index
                    word_displayed: trial.word,
                    correct_color: trial.correct_color
                },
                on_finish: function(data) {
                    const responseIndex = data.response;  // Get the index of the pressed button
                    const isCorrect = responseIndex === data.correct_response_index;  // Compare the index

                    data.correct = isCorrect ? 1 : 0;  // Store as 1 (correct) or 0 (incorrect)
                    data.responseTime = data.rt; // Capture response time

                    // Add age to the trial data
                    const lastTrialData = jsPsych.data.getLastTrialData().values()[0];
                    data.age = lastTrialData ? lastTrialData.age : null; // Capture age safely

                    // Log the payload for debugging
                    console.log(`Trial data: ${JSON.stringify(data)}`); // Log each trial data
                }
            };

            timeline.push(stroop_task);
        }

        // Final message displaying the number of correct responses and average response time
        const finalMessage = {
            type: jsPsychHtmlButtonResponse,
            stimulus: function() {
                const trialData = jsPsych.data.get().filter({ isNudge: false });  // Exclude nudge trials
                const correctCount = trialData.filter({ correct: 1 }).count();  // Count correct responses
                const totalRT = trialData.select('responseTime').values().reduce((a, b) => a + b, 0);
                const avgRT = correctCount > 0 ? (totalRT / correctCount).toFixed(2) : 0;  // Calculate average response time

                return `<p>Tak for din deltagelse!</p>
                        <p>Du havde ${correctCount} korrekte svar ud af ${totalTrials} forsøg.</p>
                        <p>Gennemsnitlig reaktionstid: ${avgRT} ms</p>`;
            },
            choices: ['OK']
        };

        timeline.push(finalMessage);

        // Send batch data to Google Sheets
        function sendBatchDataToGoogleSheets(dataArray) {
            const url = 'https://script.google.com/macros/s/AKfycbzoQtBaZrzgwzDWSAGRq-qv0kXrVk520x0B5qLs8kpeB-nCMxS_Hvo3tVPsR_4DmNh7/exec'; 
            const payload = {
                data: dataArray.map((item) => ({
                    uniqueID: item.uniqueID,
                    timestamp: timestamp,
                    correct: item.correct,
                    word: item.word_displayed,
                    congruent: item.correct === 1 ? 1 : 0, // Set congruent based on correctness
                    nudge: item.isNudge ? 1 : 0, // 1 for nudge trial, 0 otherwise
                    rt: item.responseTime,
                    age: item.age // Include age in each trial
                }))
            };

            console.log("Payload being sent:", JSON.stringify(payload)); // Log the payload for debugging

            fetch(url, {
                method: 'POST',
                mode: 'no-cors', // Ensure CORS mode is enabled
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText); // Handle non-200 responses
                }
                return response.json(); // Parse JSON response
            })
            .then(data => {
                console.log('Batch data sent successfully:', data); // Log success response
            })
            .catch(error => {
                console.error('Error sending batch data:', error); // Log fetch error
            });
        }

        // Start the experiment
        jsPsych.run(timeline).then(() => {
            const trialData = jsPsych.data.get().filter({ isNudge: false }).values();  // Get all trial data excluding nudge trials
            sendBatchDataToGoogleSheets(trialData);  // Send collected data to Google Sheets
        });
    </script>
</body>
</html>

