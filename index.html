<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stroop Opgave Eksperiment</title>
    <script src="https://unpkg.com/jspsych@8.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text@2.0.0"></script>
    <link href="https://unpkg.com/jspsych@8.0.0/css/jspsych.css" rel="stylesheet" type="text/css" />
    <style>
        body {
            background-color: black;
            color: white;
        }
        .response-button {
            padding: 10px 20px;
            margin: 10px;
            font-size: 16px;
            cursor: pointer;
        }
        .nudge-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 20px auto;
        }
    </style>
</head>
<body>
    <div id="jspsych-target"></div>

    <script>
        // Initialize JsPsych
        const jsPsych = initJsPsych({ override_safe_mode: true });

        // Mutation Observer to change "Continue" to "Forsæt"
        const observer = new MutationObserver((mutationsList) => {
            for (const mutation of mutationsList) {
                if (mutation.type === 'childList') {
                    mutation.addedNodes.forEach(node => {
                        if (node.nodeType === Node.ELEMENT_NODE) {
                            const buttons = node.querySelectorAll('button');
                            buttons.forEach(button => {
                                if (button.textContent.trim() === 'Continue') {
                                    button.textContent = 'Forsæt';
                                }
                            });
                        }
                    });
                }
            }
        });

        const targetNode = document.getElementById('jspsych-target');
        observer.observe(targetNode, { childList: true, subtree: true });

        // Unique ID for each participant
        const timestamp = new Date().toISOString();
        const uniqueID = timestamp.replace(/[:.-]/g, "");

        // Age question
        const ageQuestion = {
            type: jsPsychSurveyText,
            questions: [{ prompt: "Hvad er din alder?", required: true }],
            on_finish: function(data) {
                data.uniqueID = uniqueID;
                data.timestamp = timestamp;
                data.age = data.response; // Capture the age
                jsPsych.data.addDataToLastTrial({ age: data.age }); // Explicitly add age to the last trial
            }
        };

        // Stroop task definitions
        const stroop_trials = [
            { word: "rød", correct_color: "red" },
            { word: "grøn", correct_color: "green" },
            { word: "blå", correct_color: "blue" },
            { word: "gul", correct_color: "yellow" }
        ];

        // Get a random incorrect color, ensuring it's different from the correct one
        function getRandomIncorrectColor(correctColor) {
            const colors = ["red", "green", "blue", "yellow"];
            const incorrectColors = colors.filter(color => color !== correctColor);
            return incorrectColors[Math.floor(Math.random() * incorrectColors.length)];
        }

        const timeline = [ageQuestion];

        // Create an array of indices to randomly choose nudge trials
        const trialIndices = Array.from({ length: 20 }, (_, i) => i);
        const nudgeTrialIndices = jsPsych.randomization.sampleWithoutReplacement(trialIndices, Math.floor(20 / 3));  // Select 1/3 of trials as nudge trials (6-7 trials)

        // Create Stroop trials
        for (let i = 0; i < 20; i++) {
            const trial = stroop_trials[Math.floor(Math.random() * stroop_trials.length)];

            const isCongruentTrial = Math.random() < 0.5;
            let displayedColor;
            let correctButtonText = trial.word;
            let incorrectButtonText;

            // Determine displayed color and button text
            if (isCongruentTrial) {
                displayedColor = trial.correct_color;
                incorrectButtonText = getRandomIncorrectColor(trial.correct_color);
            } else {
                displayedColor = getRandomIncorrectColor(trial.correct_color);
                do {
                    incorrectButtonText = getRandomIncorrectColor(trial.correct_color);
                } while (incorrectButtonText === correctButtonText);
            }

            const correctButtonLeft = Math.random() < 0.5;  // Randomize button position
            const correctIndex = correctButtonLeft ? 0 : 1;  // Store the index of the correct button

            const choices = correctButtonLeft
                ? [correctButtonText, incorrectButtonText]
                : [incorrectButtonText, correctButtonText];

            // Map button text to Danish
            const buttonChoices = choices.map(color => {
                switch (color) {
                    case "red": return "rød";
                    case "green": return "grøn";
                    case "blue": return "blå";
                    case "yellow": return "gul";
                    default: return color;
                }
            });

            // If this trial is a nudge trial, first show the circle with the correct color
            if (nudgeTrialIndices.includes(i)) {
                // Nudge trial
                timeline.push({
                    type: jsPsychHtmlButtonResponse,
                    stimulus: `<div class='nudge-circle' style='background-color: ${trial.correct_color};'></div>`,
                    choices: [],  // No choices during the nudge display
                    trial_duration: 300,  // Show nudge for 300 ms
                    data: { isNudge: true }
                });
            }

            // Add the main Stroop task trial
            const stroop_task = {
                type: jsPsychHtmlButtonResponse,
                stimulus: `<p style='color: ${displayedColor}; font-size: 24px;'>${trial.word}</p>`,
                choices: buttonChoices,
                data: {
                    correct_response_index: correctIndex,  // Store the correct response index
                    word_displayed: trial.word,
                    correct_color: trial.correct_color,
                    choices: buttonChoices,
                    isCongruent: isCongruentTrial,  // Add congruency info here
                    age: (function() {
                        const lastTrialData = jsPsych.data.getLastTrialData().values()[0];
                        return lastTrialData ? lastTrialData.age : null; // Capture age safely
                    })()
                },
                on_finish: function(data) {
                    const responseIndex = data.response;  // Get the index of the pressed button
                    const isCorrect = responseIndex === data.correct_response_index;  // Compare the index

                    data.correct = isCorrect;  // Save if the response was correct
                    data.responseTime = data.rt; // Capture response time

                    // Log the payload for debugging
                    console.log(`Response index: ${responseIndex}, Correct index: ${data.correct_response_index}, Congruent: ${data.isCongruent}, Correct: ${data.correct}, Response Time: ${data.responseTime}, Age: ${data.age}`);
                }
            };

            timeline.push(stroop_task);
        }

        // Final message displaying the number of correct responses
        const finalMessage = {
            type: jsPsychHtmlButtonResponse,
            stimulus: function() {
                const correctCount = jsPsych.data.get().filter({ correct: true }).count();  // Count correct responses
                return `<p>Tak for din deltagelse!</p>
                        <p>Du havde ${correctCount} korrekte svar ud af 20.</p>`;
            },
            choices: ['OK'],
            on_finish: function() {
                // After the final message, send the data to Google Sheets
                const allData = jsPsych.data.get().values();  // Get all experiment data
                sendBatchDataToGoogleSheets(allData);  // Send data to Google Sheets
            }
        };

        timeline.push(finalMessage);

        // Send batch data to Google Sheets
        function sendBatchDataToGoogleSheets(dataArray) {
            const url = 'https://script.google.com/macros/s/AKfycbwLl08ZwClWobsVd3fE7uC6HY4LQsZk1tvOt3lGFIHpgbulCqbJan181caFYto2qV6k/exec';
            
            // Transform and sanitize the payload
            const payload = {
                data: dataArray.map((item, index) => ({
                    uniqueID: item.uniqueID || '',  // Ensure no undefined values
                    age: item.age ? item.age.Q0 : '',  // Capture age, or provide empty string if not present
                    trialNumber: index + 1,         // Trial number starts at 1
                    word: item.word_displayed || '', // Word displayed
                    displayedColor: item.correct_color || '', // Displayed color
                    response: item.response !== undefined ? item.response : '',  // Make sure response exists
                    correct: item.correct !== undefined ? item.correct : false,  // Ensure correct is boolean
                    responseTime: item.responseTime || 0,   // Default response time to 0
                    isCongruent: item.isCongruent !== undefined ? item.isCongruent : false,  // Ensure boolean
                    isNudgeTrial: item.isNudge !== undefined ? item.isNudge : false  // Default false
                }))
            };

            console.log("Payload being sent:", JSON.stringify(payload));  // Debugging

            fetch(url, {
                redirect: 'follow',
                method: 'POST',
                mode: 'cors',  // Use 'cors' instead of 'no-cors'
                cache: 'no-cache',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({payload})
            }).then(response => {
                console.log('Data successfully sent to Google Sheets:', response);
            }).catch(error => {
                console.error('Error sending data to Google Sheets:', error);
            });
        }

        // Start the experiment
        jsPsych.run(timeline);
    </script>
</body>
</html>
